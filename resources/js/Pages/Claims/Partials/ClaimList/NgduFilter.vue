<template>
    <div class="relative flex flex-col gap-2">
        <Button
            text="НГДУ"
            @click="showFilterWindow = !showFilterWindow"
            :is-active="showFilterWindow">
            <template v-if="getSelectedNgdusLenght" v-slot:suffix>
                <span
                class="text-sm font-semibold text-gray-300 dark:text-gray-400"
                >{{ `Выбрано: ${getSelectedNgdusLenght}` }}</span>
            </template>
            <template v-slot:prefix>
                <svg width="32" height="32" viewBox="0 0 32 32" class="fill-gray-400" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M7.41469 16.525V17.0099L7.75758 17.3528L8.58542 16.525C7.75758 17.3528 7.75807 17.3533 7.75856 17.3538L7.75955 17.3548L7.76161 17.3568L7.76602 17.3612L7.77597 17.3708C7.78312 17.3777 7.79128 17.3855 7.80047 17.394C7.81886 17.411 7.84139 17.4312 7.86814 17.4541C7.92165 17.4998 7.99212 17.5563 8.08031 17.6195C8.25684 17.746 8.50388 17.899 8.82692 18.0467C9.47746 18.3441 10.4144 18.6096 11.6698 18.6096C11.7132 18.6096 11.7563 18.6093 11.799 18.6086C11.0075 18.9712 10.6113 19.772 10.4037 20.3264C10.3761 20.4 10.3499 20.4749 10.3248 20.5509L5.09065 18.8441C4.83613 18.7611 4.75033 18.4443 4.92819 18.2442L7.41469 15.4469V16.525ZM12.1552 23.6106L14.5224 24.3825C14.4852 24.808 14.4646 25.2001 14.4532 25.5183C14.4442 25.7686 14.4408 25.9764 14.4396 26.123C14.439 26.1964 14.439 26.2547 14.4391 26.2954L14.4394 26.3433L14.4395 26.3568L14.4395 26.3609L14.4396 26.3623L14.4396 26.3628C14.4396 26.363 14.4396 26.3632 15.6102 26.3477C16.7808 26.3322 16.7808 26.3324 16.7808 26.3325L16.7808 26.3314L16.7807 26.3236L16.7805 26.2878C16.7804 26.2553 16.7804 26.2059 16.781 26.1419C16.782 26.0138 16.785 25.8279 16.7931 25.6024C16.7983 25.4584 16.8055 25.2995 16.8154 25.1302L18.9322 25.8205C19.9291 26.1455 21.0242 25.867 21.7446 25.105L29.3538 17.0568C30.7519 15.578 30.0845 13.1435 28.1278 12.5845L25.2906 11.7738V8.38902C25.3425 8.12398 25.3658 7.86157 25.3658 7.60971C25.3658 6.68093 25.0486 5.60853 24.1509 4.79078C23.2738 3.99169 22.1405 3.70728 21.0355 3.70728C19.9334 3.70728 18.7812 3.99151 17.9054 4.83989C17.0228 5.69489 16.7804 6.77353 16.7804 7.60971C16.7804 7.68564 16.7824 7.76357 16.7867 7.84315H16.7804V9.56265L15.9248 9.27745V8.38902C15.9767 8.12398 16.0001 7.86157 16.0001 7.60971C16.0001 6.68093 15.6828 5.60853 14.7852 4.79078C13.908 3.99169 12.7748 3.70728 11.6698 3.70728C10.5676 3.70728 9.41545 3.99151 8.53966 4.83989C7.65704 5.69489 7.41468 6.77353 7.41468 7.60971C7.41468 7.68564 7.41668 7.76357 7.42098 7.84315H7.41469V11.9225L3.17816 16.6886C1.87915 18.15 2.50582 20.464 4.36475 21.0702L9.8717 22.8659C9.81327 23.4211 9.78428 23.94 9.76986 24.3413C9.76086 24.5916 9.75742 24.7994 9.75624 24.946C9.75565 25.0194 9.75562 25.0776 9.75576 25.1184L9.75603 25.1662L9.75616 25.1798L9.7562 25.1839L9.75622 25.1853L9.75623 25.1858C9.75623 25.186 9.75623 25.1862 10.9269 25.1707C12.0975 25.1552 12.0975 25.1553 12.0975 25.1555L12.0975 25.1544L12.0974 25.1465L12.0972 25.1108C12.0971 25.0782 12.0971 25.0288 12.0976 24.9649C12.0987 24.8368 12.1017 24.6509 12.1098 24.4254C12.1184 24.1876 12.1324 23.9093 12.1552 23.6106ZM16.7804 12.0308L15.9248 11.7456V12.878V16.525V17.0099L15.5819 17.3528L14.7541 16.525C15.5819 17.3528 15.5814 17.3533 15.581 17.3538L15.58 17.3548L15.5779 17.3568L15.5735 17.3612L15.5635 17.3708C15.5564 17.3777 15.5482 17.3855 15.539 17.394C15.5206 17.411 15.4981 17.4312 15.4714 17.4541C15.4179 17.4998 15.3474 17.5563 15.2592 17.6195C15.0827 17.746 14.8356 17.899 14.5126 18.0467C14.2518 18.1659 13.9451 18.2799 13.5903 18.3739C13.9989 18.4404 14.356 18.5858 14.6511 18.7616C14.9559 18.9432 15.1835 19.149 15.3361 19.3097C15.4134 19.391 15.4742 19.4638 15.5189 19.5208C15.5413 19.5494 15.5599 19.5744 15.5746 19.5948C15.582 19.6051 15.5884 19.6142 15.5939 19.6222L15.6015 19.6332L15.6048 19.638L15.6063 19.6402L15.607 19.6413C15.6073 19.6418 15.6077 19.6423 14.6342 20.2927C13.6607 20.943 13.6611 20.9435 13.6614 20.944L13.6621 20.945L13.6633 20.9469L13.6657 20.9504L13.6698 20.9564L13.6753 20.9641C13.6765 20.9659 13.6772 20.9667 13.6772 20.9667L13.6756 20.9647C13.6712 20.959 13.6585 20.9434 13.6383 20.9221C13.5959 20.8774 13.5323 20.8206 13.4528 20.7732C13.3332 20.7019 13.1427 20.6228 12.8098 20.7271C12.7841 20.7592 12.7012 20.868 12.5964 21.1477C12.5808 21.1893 12.5656 21.2323 12.5508 21.2768L14.9114 22.0465C14.9633 21.8602 15.0216 21.678 15.087 21.5034C15.3078 20.9141 15.7415 20.0462 16.6368 19.7225C17.7572 19.3174 18.6925 19.5562 19.3344 19.9386C19.6392 20.1202 19.8668 20.326 20.0194 20.4867C20.0967 20.568 20.1576 20.6408 20.2022 20.6978C20.2246 20.7265 20.2432 20.7514 20.258 20.7719C20.2653 20.7821 20.2718 20.7912 20.2773 20.7992L20.2848 20.8102L20.2881 20.815L20.2896 20.8172L20.2903 20.8183C20.2907 20.8188 20.291 20.8193 19.3175 21.4697C18.344 22.12 18.3444 22.1205 18.3447 22.121L18.3454 22.122L18.3467 22.1239L18.3491 22.1274L18.3531 22.1334L18.3586 22.1411C18.3599 22.1429 18.3605 22.1437 18.3605 22.1437L18.359 22.1417C18.3545 22.1361 18.3419 22.1204 18.3216 22.0991C18.2792 22.0544 18.2156 21.9976 18.1361 21.9502C18.0165 21.879 17.8261 21.7998 17.4931 21.9041C17.4674 21.9362 17.3845 22.045 17.2797 22.3247C17.2291 22.4598 17.1827 22.6104 17.1403 22.7733L19.6581 23.5944C19.7946 23.6389 19.9445 23.6007 20.0432 23.4964L27.6524 15.4482C27.8438 15.2457 27.7524 14.9124 27.4845 14.8358L25.2906 14.209V16.525V17.0099L24.9477 17.3528L24.1198 16.525C24.9477 17.3528 24.9472 17.3533 24.9467 17.3538L24.9457 17.3548L24.9436 17.3568L24.9392 17.3612L24.9293 17.3708C24.9221 17.3777 24.914 17.3855 24.9048 17.394C24.8864 17.411 24.8639 17.4312 24.8371 17.4541C24.7836 17.4998 24.7131 17.5563 24.625 17.6195C24.4484 17.746 24.2014 17.899 23.8783 18.0467C23.2278 18.3441 22.2909 18.6096 21.0355 18.6096C19.7801 18.6096 18.8432 18.3441 18.1927 18.0467C17.8696 17.899 17.6226 17.746 17.4461 17.6195C17.3579 17.5563 17.2874 17.4998 17.2339 17.4541C17.2071 17.4312 17.1846 17.411 17.1662 17.394C17.157 17.3855 17.1489 17.3777 17.1417 17.3708L17.1318 17.3612L17.1274 17.3568L17.1253 17.3548L17.1243 17.3538C17.1238 17.3533 17.1233 17.3528 17.9512 16.525L17.1233 17.3528L16.7804 17.0099V16.525V12.878V12.0308ZM9.80041 15.9172C9.78521 15.9102 9.77046 15.9033 9.75615 15.8965V14.7464C10.2945 14.9076 10.9373 15.0243 11.6698 15.0243C12.4022 15.0243 13.045 14.9076 13.5834 14.7464V15.8965C13.569 15.9033 13.5543 15.9102 13.5391 15.9172C13.1901 16.0767 12.5848 16.2681 11.6698 16.2681C10.7547 16.2681 10.1494 16.0767 9.80041 15.9172ZM9.89403 12.3022C9.84509 12.2797 9.79911 12.2573 9.75615 12.2355V11.167C10.3679 11.4156 11.0273 11.5122 11.6698 11.5122C12.317 11.5122 12.9739 11.4146 13.5834 11.1732V12.2355C13.5404 12.2573 13.4944 12.2797 13.4455 12.3022C13.0371 12.4902 12.4329 12.6829 11.6698 12.6829C10.9066 12.6829 10.3024 12.4902 9.89403 12.3022ZM13.6434 7.84315C13.6311 7.93488 13.6113 8.02472 13.5834 8.11168C13.3912 8.70932 12.8149 9.17069 11.6698 9.17069C10.2187 9.17069 9.75615 8.42989 9.75615 7.60971C9.75615 6.78954 10.2187 6.04874 11.6698 6.04874C13.1208 6.04874 13.6586 6.78954 13.6586 7.60971C13.6586 7.68845 13.6536 7.76646 13.6434 7.84315ZM19.1662 15.9172C19.151 15.9102 19.1362 15.9033 19.1219 15.8965V14.7464C19.6603 14.9076 20.3031 15.0243 21.0355 15.0243C21.7679 15.0243 22.4108 14.9076 22.9491 14.7464V15.8965C22.9348 15.9033 22.92 15.9102 22.9049 15.9172C22.5558 16.0767 21.9506 16.2681 21.0355 16.2681C20.1204 16.2681 19.5152 16.0767 19.1662 15.9172ZM19.2598 12.3022C19.2108 12.2797 19.1649 12.2573 19.1219 12.2355V11.167C19.7337 11.4156 20.3931 11.5122 21.0355 11.5122C21.6827 11.5122 22.3396 11.4146 22.9491 11.1732V12.2355C22.9062 12.2573 22.8602 12.2797 22.8112 12.3022C22.4028 12.4902 21.7987 12.6829 21.0355 12.6829C20.2724 12.6829 19.6682 12.4902 19.2598 12.3022ZM23.0091 7.84315C22.9969 7.93488 22.9771 8.02472 22.9491 8.11168C22.757 8.70932 22.1807 9.17069 21.0355 9.17069C19.5844 9.17069 19.1219 8.42989 19.1219 7.60971C19.1219 6.78954 19.5844 6.04874 21.0355 6.04874C22.4866 6.04874 23.0243 6.78954 23.0243 7.60971C23.0243 7.68845 23.0194 7.76646 23.0091 7.84315Z"/>
                </svg>

            </template>
        </Button>

        <div v-show="showFilterWindow" class="z-[50] p-4 top-[105%] absolute flex flex-col gap-2 w-auto shadow-lg dark:shadow-2xl bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg select-none">
            <!-- Drop all button -->
            <DropAll v-if="selectedNgdus.length > 0" @click="dropAllNgdu" />
            <!-- Ngdu cards -->
            <div v-if="!dataLoading && data.length > 0" class="w-full flex flex-col gap-1">
                <div v-for="(ngdu, index) in data"
                @click="selectNgdu(ngdu)"
                :key="index"
                :class="{ 'border-green-400 hover:border-green-400' : isSelected(ngdu) }"
                class="flex items-center gap-2 p-2 w-full border border-gray-200
                 dark:border-gray-800 rounded-lg cursor-pointer hover:border-gray-300 dark:hover:border-gray-700">
                    <!-- Checkbox -->
                    <div
                    :class="{ 'border-green-400 bg-green-400' : isSelected(ngdu) }"
                    class="flex items-center justify-center w-4 h-4 rounded-md border border-gray-200 dark:border-gray-800">
                        <span v-if="isSelected(ngdu)" class="text-[13px] text-white font-semibold">{{ getNumber(ngdu) }}</span>
                    </div>
                    <span class="text-[12px] text-gray-800 dark:text-white font-semibold whitespace-nowrap">{{ ngdu.name }}</span>
                </div>
            </div>
            <!-- No data -->
            <div v-else-if="!dataLoading && data.length === 0" class="w-full py-10 flex items-center justify-center">
                <span class="text-[13px] text-gray-300 dark:text-gray-600 font-semibold">Нет данных</span>
            </div>
            <!-- Loading -->
            <div v-else class="w-full py-10 flex items-center justify-center">
                <Spinner class="fill-gray-400" />
            </div>
        </div>
    </div>

</template>

<script setup>
import axios from 'axios';
import { computed, onMounted, ref, watch } from 'vue';
import { Spinner } from 'flowbite-vue';
import Button from '@/Components/Button.vue';
import DropAll from './DropAll.vue'

const showFilterWindow = ref(false);
const dataLoading = ref(false);
const data = ref([]);
const selectedNgdus = ref([]);

function fetchNgdu() {
    dataLoading.value = true;

    axios.get('/api/ngdu/all')
    .catch(err => {
        dataLoading.value = false;
    }).then(res => {
        data.value = res.data;
        dataLoading.value = false;
    })
};

function isSelected(ngdu) {
    return selectedNgdus.value.includes(ngdu)
}

function getNumber(ngdu) {
    return selectedNgdus.value.indexOf(ngdu) + 1;
}

function selectNgdu(ngdu) {
    if (isSelected(ngdu)) {
        selectedNgdus.value.splice(selectedNgdus.value.indexOf(ngdu), 1);
        return;
    }
    selectedNgdus.value.push(ngdu);

}

const selecetedNgduIds = computed(() => {
    return selectedNgdus.value.map(item => {return item.id});
})

function dropAllNgdu() {
    selectedNgdus.value = []
}

const getSelectedNgdusLenght = computed(() => {
    return selectedNgdus.value.length;
})

onMounted(() => {
    fetchNgdu();
})

watch(selecetedNgduIds, (newValue) => {
    emit('change', newValue);
}, { deep: true });

const emit = defineEmits(['change']);
</script>
